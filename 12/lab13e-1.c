#include <semaphore.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

int main(void) {
    int n = 0;
    int fd;
    char *sh;
    sem_t *sem;

    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ —Å –∏–º–µ–Ω–µ–º "/common_region"
    // —Å —Ñ–ª–∞–≥–∞–º–∏ O_RDWR (–æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏), O_CREAT (—Å–æ–∑–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    // –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ S_IRUSR (—á—Ç–µ–Ω–∏–µ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞), S_IWUSR (–∑–∞–ø–∏—Å—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞), S_IRGRP (—á—Ç–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã)
    fd = shm_open("/common_region", O_RDWR | O_CREAT, S_IRUSR | S_IWUSR | S_IRGRP);

    if (fd == -1) fprintf(stderr, "shm_open\n");

    ftruncate(fd, 6); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—â–µ–π –æ–±–ª–∞—Å—Ç–∏ –ø–∞–º—è—Ç–∏ –≤ 6 –±–∞–π—Ç

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    // —Å –ø—Ä–∞–≤–∞–º–∏ PROT_READ (—á—Ç–µ–Ω–∏–µ), PROT_WRITE (–∑–∞–ø–∏—Å—å) –∏ —Ñ–ª–∞–≥–æ–º MAP_SHARED (—Å–æ–∑–¥–∞–µ–º –æ–±—â–µ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    sh = (char *) mmap(0, 6, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);

    if (sh == MAP_FAILED) fprintf(stderr, "mmap\n");

    memset(sh, 0, 6);

    sem = sem_open("/common_sem", O_CREAT, S_IRUSR | S_IWUSR | S_IRGRP, 1);

    // üö¶ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    if (sem == SEM_FAILED) fprintf(stderr, "sem_open");

    while (1) {
        n++;
        sem_wait(sem); // –û–∂–∏–¥–∞–µ–º, –∫–æ–≥–¥–∞ üö¶ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º (—É–º–µ–Ω—å—à–∞–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ 1)
        //write(fileno(stdout),sh, 6);
        printf("String: %s\n", sh); // –í—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±—â–µ–π –æ–±–ª–∞—Å—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ printf
        sem_post(sem); // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–µ–º–∞—Ñ–æ—Ä (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ 1)
        usleep(100);
    }

    // –£–¥–∞–ª—è–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, –ø–∞–º—è—Ç—å, –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π üö¶ –∏ –µ–≥–æ —Å–∞–º–æ–≥–æ
    shm_unlink("/common_region");
    munmap(sh, 6);
    sem_unlink("/common_sem");
    sem_close(sem);
    return 0;
}